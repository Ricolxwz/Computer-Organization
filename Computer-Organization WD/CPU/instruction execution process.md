## 指令执行过程

### 指令周期

指令周期: CPU从主存中每取出并执行一条指令所花的全部时间
</br> 指令周期常常用若干机器周期来表示, 机器周期又叫CPU周期
</br> 一个机器周期又包含若干时钟周期(也称为节拍、T周期或者CPU时钟周期, 它是CPU操作的最基本单位)

每个指令周期内机器周期数可以不等, 每个机器周期内的节拍数也可以不等, 如: 
> 空指令NOP: 取址周期
> </br> 加法指令ADD: 取址周期+执行周期
> </br> 取址周期+较长的执行周期
> </br> 取址周期+间接寻址周期+执行周期
> </br> 取址周期+间接寻址周期+执行周期+中断周期

### 指令周期流程

![](https://github.com/Ricolxwz/Computer-Organization-408/blob/main/Computer-Organization%20WD/CPU/SVG/instruction%20execution%20process1.drawio.svg)

四个工作周期都有CPU访存操作, 只是访存的目的不同. 取址周期是为了取指令, 间址周期是为了取有效地址, 执行周期是为了取操作数, 中断周期是为了保存程序断点

### 指令周期的数据流—取址周期

1. 当前指令地址送至存储器地址寄存器, 记做: (PC)->MAR
2. CU发出控制信号, 经控制总线传到主存, 这里是读信号, 记做: 1->R
3. 将MAR所指主存中的内容经数据总线送入MDR, 记做M(MAR)->MDR
4. 将MDR中的内容(此时是指令)送入IR, 记做: (MDR)->IR
5. CU发出控制信号, 形成下一条指令地址, 记做: (PC)+1->PC

### 指令周期的数据流-间址周期

1. 将指令的地址码放入MAR, 记做: Ad(IR)->MAR或者是Ad(MDR)->MAR
2. CU发出控制信号, 启动主存读操作, 记做: 1->R
3. 将MAR所指主存中的内容经过数据总线送入MDR, 记做: M(MAR)->MDR
4. 将有效地址送至指令的地址码字段, 记做: (MDR)->Ad(IR)

### 指令周期的数据流-执行周期

执行周期的任务是根据IR中的指令字的操作码和操作数通过ALU操作产生执行结果. 不同指令的执行周期操作数不同, 因此没有统一的数据流向

### 指令周期的数据流-中断周期

暂停执行当前的程序去执行其他的程序. 为了能够恢复当前任务, 需要保存断点. 一般用堆栈来保存断点, 这里用SP表示栈顶地址, 假设SP指向栈顶元素, 进栈操作是先修改指针, 后存入数据.

中断周期中的进栈操作是将SP减1, 这和传统意义上的进栈操作相反, 原因是计算机的堆栈中都是向低地址增加, 所以进栈操作是减1而不是加1

1. CU控制将SP-1, 修改后的地址送入MAR, 记做: (SP)-1->SP, (SP)->MAR. 本质上是将断点存入某个存储单元, 假设其地址为a, 故可以记做: a->MAR
2. CU发出控制信号, 启动主存做写操作, 记做: 1->w
3. 将断点(PC内容)送入MDR, 记做(PC)->MDR
4. CU控制将中断服务程序的入口地址(由向量地址形成部件产生)送入PC, 记做: 向量地址->PC

### 指令执行方案

一个指令周期通常包括几个时间段(执行步骤), 每个步骤完成指令的一部分功能, 几个依次执行的步骤完成这条指令的全部功能

#### 单指令周期

对所有指令选用相同的执行时间来完成, 指令之间串行执行, 指令周期取决于执行时间最长的指令的执行时间

#### 多指令周期

对于不同类型的指令选用不同的执行步骤来完成. 指令之间串行执行; 可选用不同个数的时钟周期来完成不同指令的执行过程

#### 流水线方案

在每一个时钟周期启动一条指令, 尽量让多条指令同时运行, 但各自处在不同的执行步骤中, 指令之间并行执行